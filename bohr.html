<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bohr Model Simulator v7 - Fixed Collisions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calc-font { font-family: 'Courier New', Courier, monospace; }
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .math-step { 
            background: rgba(15, 23, 42, 0.6); 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 8px; 
            border-left: 4px solid #10b981;
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 p-4">

    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-blue-400">Bohr Model Physics Lab</h1>
        <p class="text-slate-500 text-sm">Corrected Collision Engine & Step-by-Step Math</p>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-7 space-y-4">
            <div id="sim-container" class="relative bg-slate-950 rounded-xl border border-slate-700 overflow-hidden h-[450px] flex items-center justify-center">
                <canvas id="atomCanvas" width="500" height="500"></canvas>
                <div id="particle-layer" class="absolute inset-0 pointer-events-none"></div>
                
                <div class="absolute top-4 left-4 bg-slate-900/90 p-3 rounded border border-slate-600 text-xs font-mono space-y-2 shadow-xl">
                    <div class="text-blue-300">Orbit State: <span id="n-val" class="text-white font-bold">1</span></div>
                    <div class="text-green-300">Energy Level: <span id="e-val" class="text-white">-13.60 eV</span></div>
                    <div class="pt-2 border-t border-slate-700">
                        <span class="text-purple-400 font-bold uppercase text-[10px]">Angular Momentum (L = nh / 2pi):</span><br>
                        <span id="l-val" class="text-white text-sm">1.055 × 10⁻³⁴ J·s</span>
                    </div>
                </div>
            </div>

            <div id="status-message" class="bg-slate-800 p-5 rounded-xl border border-slate-700 h-[220px] overflow-y-auto font-mono">
                <div class="text-slate-400 italic">System Ready. Please fire a particle or change n manually to see calculations...</div>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-4">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-purple-400 uppercase tracking-widest text-sm">Experiment Controls</h3>
                    <button onclick="resetAtom()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-xs font-bold transition shadow-lg active:scale-95">↺ RESET ATOM</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-slate-900 p-4 rounded border border-slate-700">
                        <label class="block text-[10px] text-yellow-500 font-bold mb-2 uppercase">Photon (γ) Collision</label>
                        <div class="flex gap-2">
                            <input type="number" id="photon-in" value="10.20" step="0.01" class="w-full bg-black text-yellow-400 px-2 py-1 rounded text-sm border border-slate-600 outline-none">
                            <button onclick="fire('photon')" class="bg-yellow-600 hover:bg-yellow-500 px-3 py-1 rounded text-xs font-bold transition">FIRE</button>
                        </div>
                    </div>
                    <div class="bg-slate-900 p-4 rounded border border-slate-700">
                        <label class="block text-[10px] text-red-500 font-bold mb-2 uppercase">Electron (e⁻) Collision</label>
                        <div class="flex gap-2">
                            <input type="number" id="electron-in" value="12.10" step="0.01" class="w-full bg-black text-red-400 px-2 py-1 rounded text-sm border border-slate-600 outline-none">
                            <button onclick="fire('electron')" class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-xs font-bold transition">FIRE</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="block text-[10px] text-slate-500 font-bold uppercase">Set Principal Quantum Number (n)</label>
                    <div class="flex gap-2">
                        <button onclick="jumpTo(1)" class="flex-1 py-2 bg-slate-700 hover:bg-blue-600 rounded text-xs transition font-bold">n=1</button>
                        <button onclick="jumpTo(2)" class="flex-1 py-2 bg-slate-700 hover:bg-blue-600 rounded text-xs transition font-bold">n=2</button>
                        <button onclick="jumpTo(3)" class="flex-1 py-2 bg-slate-700 hover:bg-blue-600 rounded text-xs transition font-bold">n=3</button>
                        <button onclick="jumpTo(4)" class="flex-1 py-2 bg-slate-700 hover:bg-blue-600 rounded text-xs transition font-bold">n=4</button>
                        <button onclick="ionize()" class="flex-1 py-2 bg-red-900/50 border border-red-700 rounded text-xs font-bold">n=∞</button>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <h3 class="text-xs font-bold text-slate-400 mb-4">ENERGY LEVELS (1/n²)</h3>
                <div id="energy-levels" class="relative h-[150px] border-l border-slate-600 ml-8"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const E1 = -13.6; 
        const H_BAR = 1.05457e-34; 
        const HC_EV_M = 1.24e-6; 
        const BASE_R = 18;

        // --- State ---
        let currentN = 1;
        let isIonized = false;
        let angle = 0;
        let animationFrame;

        const canvas = document.getElementById('atomCanvas');
        const ctx = canvas.getContext('2d');
        const pLayer = document.getElementById('particle-layer');

        function animate() {
            ctx.clearRect(0, 0, 500, 500);
            const cx = 250, cy = 250;

            // Nucleus
            ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.fillStyle="#ef4444"; ctx.fill();
            ctx.fillStyle="white"; ctx.font="bold 10px Arial"; ctx.fillText("+", cx-3, cy+4);

            // Allowed Orbits
            ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 1;
            for(let i=1; i<=4; i++){
                ctx.beginPath(); ctx.arc(cx, cy, i*i*BASE_R, 0, Math.PI*2); ctx.stroke();
            }

            // Electron
            if(!isIonized){
                const r = currentN * currentN * BASE_R;
                angle += 0.03 / currentN;
                const ex = cx + r * Math.cos(angle);
                const ey = cy + r * Math.sin(angle);
                
                // Active Orbit Glow
                ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.strokeStyle="#3b82f6"; ctx.lineWidth=2; ctx.stroke();
                // Electron
                ctx.beginPath(); ctx.arc(ex, ey, 6, 0, Math.PI*2); ctx.fillStyle="#60a5fa"; ctx.fill();
                ctx.shadowBlur = 10; ctx.shadowColor = "#60a5fa";
                ctx.fill(); ctx.shadowBlur = 0;
            }

            animationFrame = requestAnimationFrame(animate);
        }

        // --- Logic Functions ---

        function updateUI() {
            document.getElementById('n-val').innerText = isIonized ? "∞" : currentN;
            const energy = isIonized ? 0 : E1 / (currentN * currentN);
            document.getElementById('e-val').innerText = energy.toFixed(2) + " eV";
            
            // 角動量計算 L = n * h_bar
            const L = isIonized ? "N/A" : (currentN * H_BAR).toExponential(3) + " J·s";
            document.getElementById('l-val').innerText = L;

            drawEnergyLevels();
        }

        function drawEnergyLevels() {
            const container = document.getElementById('energy-levels');
            container.innerHTML = `<div class="absolute top-0 w-full border-t border-dashed border-red-500 opacity-50"><span class="text-[9px] text-red-400 ml-2">0 eV</span></div>`;
            for(let i=1; i<=4; i++){
                const pos = (1 - (1/(i*i))) * 100;
                const active = (currentN === i && !isIonized);
                const line = document.createElement('div');
                line.className = `absolute w-full border-t-2 transition-all ${active ? 'border-blue-400' : 'border-slate-700'}`;
                line.style.bottom = pos + "%";
                line.innerHTML = `<span class="text-[9px] absolute -left-8 -top-2">n=${i}</span>`;
                container.appendChild(line);
            }
        }

        function log(html) {
            const box = document.getElementById('status-message');
            box.innerHTML = html;
        }

        function fire(type) {
            const inputId = type === 'photon' ? 'photon-in' : 'electron-in';
            const val = parseFloat(document.getElementById(inputId).value);
            
            // Create Visual Particle
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = '-40px'; 
            p.style.top = '235px';
            p.style.width = '30px'; 
            p.style.height = '30px';
            
            if(type === 'photon') {
                p.style.background = "radial-gradient(circle, #fef08a, #ca8a04)";
                p.style.boxShadow = "0 0 15px #fde047";
                p.innerHTML = "γ";
            } else {
                p.style.background = "radial-gradient(circle, #fca5a5, #b91c1c)";
                p.style.boxShadow = "0 0 10px #ef4444";
                p.innerHTML = "e⁻";
            }
            
            pLayer.appendChild(p);

            let posX = -40;
            const animateParticle = setInterval(() => {
                posX += 8;
                p.style.left = posX + 'px';
                
                // Collision Detection at Center
                if(posX >= 235) {
                    clearInterval(animateParticle);
                    handleCollisionLogic(type, val);
                    p.style.opacity = '0';
                    setTimeout(() => p.remove(), 300);
                }
            }, 16);
        }

        function handleCollisionLogic(type, incomingE) {
            if(isIonized) {
                log("<span class='text-red-400'>Atom is ionized. Electron is already gone!</span>");
                return;
            }

            const currentE = E1 / (currentN * currentN);
            const ionizationEnergy = Math.abs(currentE);

            if(type === 'photon') {
                if(incomingE >= ionizationEnergy - 0.01) {
                    ionizeWithDetail(incomingE, ionizationEnergy);
                } else {
                    let transitionN = -1;
                    for(let n=currentN+1; n<=10; n++){
                        const diff = (E1/(n*n)) - currentE;
                        if(Math.abs(incomingE - diff) < 0.05) { transitionN = n; break; }
                    }
                    if(transitionN !== -1) jumpTo(transitionN, incomingE);
                    else log(`<b>Photon energy ${incomingE}eV does not match any transition.</b><br>Transparent: Photon passes through.`);
                }
            } else {
                // Electron Collision (Inelastic allowed)
                if(incomingE >= ionizationEnergy) {
                    ionizeWithDetail(incomingE, ionizationEnergy);
                } else {
                    let bestTarget = currentN;
                    let cost = 0;
                    for(let n=10; n>currentN; n--) {
                        const diff = (E1/(n*n)) - currentE;
                        if(incomingE >= diff) { bestTarget = n; cost = diff; break; }
                    }
                    if(bestTarget > currentN) {
                        log(`<b>Inelastic Collision!</b><br>Incident e⁻ KE: ${incomingE}eV<br>Absorbed by atom: ${cost.toFixed(2)}eV<br>Remaining e⁻ KE: ${(incomingE-cost).toFixed(2)}eV`);
                        jumpTo(bestTarget);
                    } else {
                        log(`<b>Elastic Collision.</b><br>Incident KE (${incomingE}eV) is less than first excitation level.`);
                    }
                }
            }
        }

        function ionizeWithDetail(incoming, cost) {
            isIonized = true;
            updateUI();
            log(`<b class='text-red-400 underline'>IONIZATION SUCCESS!</b><br>Incoming Energy: ${incoming.toFixed(2)} eV<br>Energy to remove electron: ${cost.toFixed(2)} eV<br>Escaping Electron KE: ${(incoming-cost).toFixed(2)} eV`);
        }

        function jumpTo(n, absorbedE = null) {
            const oldN = currentN;
            if(isIonized) { isIonized = false; currentN = n; updateUI(); return; }

            // Step-by-Step Wavelength Calculation for Emission
            if(n < currentN) {
                const eI = E1 / (currentN * currentN);
                const eF = E1 / (n * n);
                const dE = Math.abs(eF - eI);
                const wavelength = HC_EV_M / dE;

                let html = `<b>Emission: Electron fell from n=${currentN} to n=${n}</b>`;
                html += `<div class="math-step">`;
                html += `<b>Step 1: Calculate Energy Difference (ΔE)</b><br>`;
                html += `ΔE = |E_final - E_initial|<br>`;
                html += `ΔE = |${eF.toFixed(2)} eV - (${eI.toFixed(2)} eV)| = <span class="text-blue-400">${dE.toFixed(2)} eV</span><br><br>`;
                html += `<b>Step 2: Substitution into $\lambda = hc / \Delta E$</b><br>`;
                html += `$\lambda$ = (1.24 × 10⁻⁶ eV·m) / ${dE.toFixed(2)} eV<br><br>`;
                html += `<b>Step 3: Final Wavelength</b><br>`;
                html += `$\lambda$ = <span class="text-green-400 font-bold">${wavelength.toExponential(3)} m</span>`;
                html += `</div>`;
                log(html);
            } else if (absorbedE) {
                log(`<b>Excitation: Absorbed ${absorbedE.toFixed(2)} eV</b><br>Jumped: n=${oldN} → n=${n}`);
            }

            currentN = n;
            updateUI();
        }

        function ionize() { isIonized = true; updateUI(); log("<b>Manual Ionization:</b> Atom is now a Hydrogen Ion (H⁺)."); }

        function resetAtom() {
            cancelAnimationFrame(animationFrame);
            isIonized = false;
            currentN = 1;
            angle = 0;
            updateUI();
            animate();
            log("<span class='text-slate-400 italic'>Atom reset to Ground State (n=1).</span>");
        }

        // Initialize
        updateUI();
        animate();
    </script>
</body>
</html>
